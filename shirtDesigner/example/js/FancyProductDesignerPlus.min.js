/*
* Fancy Product Designer Plus 1.0.3 
* An Add-On for Fancy Product Designer. 
* Copyright 2016, Rafael Dery
*
* Only for the sale at the envato marketplaces
*/
var FancyProductDesignerPlus={version:"1.0.3",setup:function(a,b){b.mainOptions.colorSelectionPlacement&&""!==b.mainOptions.colorSelectionPlacement&&new FPDColorSelection(b),a.on("langJSONLoad",function(){if(b.mainOptions.bulkVariationsPlacement&&b.mainOptions.bulkVariations){var a=new FPDBulkVariations(b);b.bulkVariations=a}}),-1!=b.mainOptions.mainBarModules.indexOf("names-numbers")&&a.on("viewCreate",function(a,b){b.names_numbers&&b.names_numbers.length>1&&b.changePrice((b.names_numbers.length-1)*b.options.namesNumbersEntryPrice,"+")})}};FancyProductDesignerPlus.availableModules=["names-numbers","drawing"];var FPDNamesNumbersModule={setup:function(a,b){var c=null;b.off().find(".fpd-list").empty();var d=function(b,c){a.currentViewInstance.numberPlaceholder&&"string"==typeof b&&a.currentViewInstance.setElementParameters({text:b},a.currentViewInstance.numberPlaceholder),a.currentViewInstance.textPlaceholder&&"string"==typeof c&&a.currentViewInstance.setElementParameters({text:c},a.currentViewInstance.textPlaceholder),a.currentViewInstance.stage.renderAll()},e=function(c,d,e){c="undefined"==typeof c?"":c,d="undefined"==typeof d?"":d;var f='<div class="fpd-row">';if(a.currentViewInstance.numberPlaceholder){var g="";Array.isArray(a.currentViewInstance.numberPlaceholder.numberPlaceholder)&&(g='min="'+a.currentViewInstance.numberPlaceholder.numberPlaceholder[0]+'" max="'+a.currentViewInstance.numberPlaceholder.numberPlaceholder[1]+'" '),f+='<div class="fpd-number-col"><input type="number" placeholder="'+a.currentViewInstance.numberPlaceholder.originParams.text+'" class="fpd-number" value="'+c+'" '+g+" /></div>"}if(a.currentViewInstance.textPlaceholder&&(f+='<div class="fpd-name-col"><div><input type="text" placeholder="'+a.currentViewInstance.textPlaceholder.originParams.text+'" value="'+d+'" /></div></div>'),a.mainOptions.namesNumbersDropdown&&a.mainOptions.namesNumbersDropdown.length>0||e){for(var h=new Array(e),i=a.mainOptions.namesNumbersDropdown.length>0?a.mainOptions.namesNumbersDropdown:h,j="",k=0;k<i.length;++k)selected=e===i[k]?'selected="selected"':"",j+='<option value="'+i[k]+'" '+selected+">"+i[k]+"</option>";f+='<div class="fpd-select-col"><label><select>'+j+"</select></label></div>"}return f+='<div class="fpd-remove-col"><span><span class="fpd-icon-remove"></span></span></div></div></div>',b.find(".fpd-list").append(f),FPDUtil.createScrollbar(b.find(".fpd-scroll-area")),b.find(".fpd-list .fpd-row:last")};if(a.currentViewInstance.textPlaceholder||a.currentViewInstance.numberPlaceholder)if(b.children(".fpd-names-numbers-panel").toggleClass("fpd-disabled",!1),a.currentViewInstance.names_numbers&&Array.isArray(a.currentViewInstance.names_numbers))for(var f=0;f<a.currentViewInstance.names_numbers.length;++f){var g=a.currentViewInstance.names_numbers[f];e(g.number,g.name,g.select)}else e();else b.children(".fpd-names-numbers-panel").toggleClass("fpd-disabled",!0);b.on("click",".fpd-remove-col",function(){var d=$(this).parents(".fpd-row:first");d.siblings(".fpd-row").length>0&&(d.remove(),c&&c.get(0)===d.get(0)&&b.find(".fpd-row:first input:first").mouseup(),a.currentViewInstance.names_numbers=FPDNamesNumbersModule.getViewNamesNumbers(b),a.currentViewInstance.changePrice(a.currentViewInstance.options.namesNumbersEntryPrice,"-"))}),b.on("mouseup keyup",".fpd-row input",function(){var b=$(this);if(c&&c.get(0)!==b.parents(".fpd-row:first").get(0)){var e=b.parents(".fpd-row:first");d(e.find(".fpd-number").val(),e.find(".fpd-name-col input").val())}else{var f=b.hasClass("fpd-number")?a.currentViewInstance.numberPlaceholder.maxLength:a.currentViewInstance.textPlaceholder.maxLength;0!=f&&this.value.length>f&&(this.value=this.value.substr(0,f)),b.hasClass("fpd-number")?(void 0!==b.attr("min")&&""!==this.value&&(this.value>Number(b.attr("max"))&&(this.value=Number(b.attr("max"))),this.value<Number(b.attr("min"))&&(this.value=Number(b.attr("min")))),d(this.value)):d(!1,this.value)}c=b.parents(".fpd-row:first")}),b.on("click",".fpd-btn",function(){var f=e();b.find(".fpd-list .fpd-row:last input:first").focus(),d(f.find(".fpd-number").attr("placeholder"),f.find(".fpd-name-col input").attr("placeholder")),a.currentViewInstance.names_numbers=FPDNamesNumbersModule.getViewNamesNumbers(b),a.currentViewInstance.changePrice(a.currentViewInstance.options.namesNumbersEntryPrice,"+"),c=f}),b.on("change","input, select",function(){a.currentViewInstance.names_numbers=FPDNamesNumbersModule.getViewNamesNumbers(b)})},getViewNamesNumbers:function(a){var b=[];return a.find(".fpd-list .fpd-row").each(function(a,c){var d=$(c),e={};d.children(".fpd-number-col").length>0&&(e.number=d.find(".fpd-number").val()),d.children(".fpd-name-col").length>0&&(e.name=d.find(".fpd-name-col input").val()),d.children(".fpd-select-col").length>0&&(e.select=d.find(".fpd-select-col select").val()),b.push(e)}),b}},FPDDrawingModule=function(a,b){var c=null,d="#000000",e=function(a,b){if("vLine"===b){var c=new fabric.PatternBrush(a);return c.getPatternSrc=function(){var a=fabric.document.createElement("canvas");a.width=a.height=10;var b=a.getContext("2d");return b.strokeStyle=this.color,b.lineWidth=5,b.beginPath(),b.moveTo(0,5),b.lineTo(10,5),b.closePath(),b.stroke(),a},c}if("hLine"===b){var d=new fabric.PatternBrush(a);return d.getPatternSrc=function(){var a=fabric.document.createElement("canvas");a.width=a.height=10;var b=a.getContext("2d");return b.strokeStyle=this.color,b.lineWidth=5,b.beginPath(),b.moveTo(5,0),b.lineTo(5,10),b.closePath(),b.stroke(),a},d}},f=function(){var f=b.parents(".fpd-draggable-dialog:first").length>0?b.parents(".fpd-draggable-dialog:first").width():b.parent(".fpd-content").width();f-=2*parseInt(b.css("paddingLeft")),c=new fabric.Canvas(b.find(".fpd-drawing-canvas").get(0),{containerClass:"fpd-drawing-container",isDrawingMode:!0,width:f,height:150}),b.find(".fpd-drawing-brush-type .fpd-item").click(function(a){a.stopPropagation();var f=$(this),g=f.parent().prevAll(".fpd-dropdown-current:first"),h=f.data("value");g.html(f.clone()).data("value",h),c.freeDrawingBrush="hline"===h?e(c,"hLine"):"vline"===h?e(c,"vLine"):new fabric[h+"Brush"](c),c.freeDrawingBrush&&(c.freeDrawingBrush.color=d,c.freeDrawingBrush.width=b.find(".fpd-drawing-line-width").val()),f.parents(".fpd-dropdown:first").removeClass("fpd-active")}),b.find(".fpd-drawing-line-color").spectrum({color:d,showButtons:!1,preferredFormat:"hex",showInput:!0,showInitial:!0,showPalette:a.mainOptions.colorPickerPalette&&a.mainOptions.colorPickerPalette.length>0,palette:a.mainOptions.colorPickerPalette,move:function(a){d=a.toHexString(),c&&(c.freeDrawingBrush.color=d)},change:function(a){d=a.toHexString(),c&&(c.freeDrawingBrush.color=d)}}),b.find(".fpd-slider-range").rangeslider({polyfill:!1,rangeClass:"fpd-range-slider",disabledClass:"fpd-range-slider--disabled",horizontalClass:"fpd-range-slider--horizontal",verticalClass:"fpd-range-slider--vertical",fillClass:"fpd-range-slider__fill",handleClass:"fpd-range-slider__handle",onSlide:function(a,b){this.$element.parent().prev(".fpd-slider-number").val(b).change()}}),b.find(".fpd-slider-number").change(function(){var a=$(this);this.value>Number(a.attr("max"))&&(this.value=Number(a.attr("max"))),this.value<Number(a.attr("min"))&&(this.value=Number(a.attr("min"))),a.next(".fpd-range-wrapper").children("input").val(this.value).rangeslider("update",!0,!1),a.hasClass("fpd-drawing-line-width")&&c&&(c.freeDrawingBrush.width=this.value)}),b.find(".fpd-clear-drawing").click(function(){c.clear()}),b.find(".fpd-add-drawing").click(function(){a.addElement("image",c.toSVG(),(new Date).getTime(),{autoCenter:!0,draggable:!0,resizable:!0,removable:!0,rotatable:!0,autoSelect:!0,colors:!1,patterns:!1}),c.clear()})};f()},FPDColorSelection=function(a){var b=null,c=!1,d=a.mainOptions.colorSelectionPlacement,e=function(b){var c=a.mainOptions.hexNames[b.replace("#","")];c=c?c:b;var d=a.mainOptions.colorSelectionTooltip?'title="'+c+'"':"";return'<div style="background-color: '+b+'" class="fpd-item fpd-tooltip" '+d+'><div class="fpd-label">'+b+"</div></div>"},f=function(){a.$container.on("productCreate",function(){if(a.currentViews.length>0&&a.currentViews[0].mainElement){null==b&&(b=-1!==d.indexOf("inside-")?a.$mainWrapper.append('<div class="fpd-color-selection fpd-clearfix fpd-'+d+'"></div>').children(".fpd-color-selection"):$(d).addClass("fpd-color-selection fpd-clearfix fpd-custom-pos"),b.on("click",".fpd-item",function(){var b=tinycolor($(this).css("backgroundColor"));a.deselectElement(),a.currentViewInstance.currentUploadZone=null,a.viewInstances[0].setElementParameters({fill:b.toHexString()},a.currentViews[0].mainElement)})),b.find("input").spectrum("destroy"),b.empty();var f=a.viewInstances[0].getElementByTitle(a.currentViews[0].mainElement);if(f&&Array.isArray(f.colors)&&f.colors.length>0)if(1===f.colors.length)b.append('<input type="text" value="'+f.colors[0]+'" />'),b.children("input").spectrum({showButtons:!1,preferredFormat:"hex",showInput:!0,showInitial:!0,showPalette:a.mainOptions.colorPickerPalette&&a.mainOptions.colorPickerPalette.length>0,palette:a.mainOptions.colorPickerPalette,show:function(a){f._tempFill=a.toHexString()},move:function(b){(c===!1||"png"!==FPDUtil.elementIsColorizable(f))&&a.viewInstances[0].changeColor(f,b.toHexString())},change:function(b){$(document).unbind("click.spectrum"),a.viewInstances[0].setElementParameters({fill:b.toHexString()},f)}}).on("dragstart.spectrum",function(){c=!0}).on("dragstop.spectrum",function(b,d){c=!1,a.viewInstances[0].changeColor(f,d.toHexString())});else{for(var g=0;g<f.colors.length;++g)b.append(e(f.colors[g]));a.mainOptions.colorSelectionTooltip&&FPDUtil.updateTooltip(b)}b.show()}else b&&b.hide()})};f()},FPDBulkVariations=function(a){var b=this,c=$(a.mainOptions.bulkVariationsPlacement).addClass("fpd-bulk-variations fpd-container"),d=a.mainOptions.bulkVariations,e="";this.getOrderVariations=function(){var a=[];return c.find(".fpd-row").each(function(b,c){var d=$(c),e={};d.children(".fpd-select-col").each(function(b,c){var d=$(c).children("select");null==d.val()&&(a=!1,d.addClass("fpd-error")),e[d.attr("name")]=d.val()}),a!==!1&&a.push({variation:e,quantity:parseInt(d.find(".fpd-quantity").val())})}),a},this.setup=function(a){"object"==typeof a&&(c.children(".fpd-variations-list").empty(),a.forEach(function(a){c.children(".fpd-variations-list").append(e);var b=c.children(".fpd-variations-list").children(".fpd-row:last");Object.keys(a.variation).forEach(function(c){b.find('select[name="'+c+'"]').val(a.variation[c])}),b.find(".fpd-quantity").val(a.quantity)})),f()};var f=function(){var b=0;c.find(".fpd-quantity").each(function(){b+=Number(this.value)}),a.setOrderQuantity(Number(b))},g=function(){if(a.$container.on("getOrder",function(){a._order.bulkVariations=b.getOrderVariations()}),"object"==typeof d){var g=Object.keys(d);e+='<div class="fpd-row">';for(var h=0;h<g.length;++h){var i=g[h],j=d[i];e+='<div class="fpd-select-col"><select name="'+i+'"><option value="" disabled selected>'+i+"</option>";for(var k=0;k<j.length;++k)e+='<option value="'+j[k]+'">'+j[k]+"</option>";e+="</select></div>"}e+='<div><input type="number" class="fpd-quantity" step="1" min="1" value="1" /></div>',e+='<div class="fpd-remove-row"><span class="fpd-icon-close"></span></div>',e+="</div>"}c.append('<div class="fpd-variations-list">'+e+"</div>").prepend('<div class="fpd-clearfix"><span class="fpd-title fpd-left">'+a.getTranslation("plus","bulk_add_variations_title")+'</span><span class="fpd-add-row fpd-btn fpd-right">'+a.getTranslation("plus","bulk_add_variations_add")+"</span></div>"),c.on("click",".fpd-add-row",function(){c.children(".fpd-variations-list").append(e),f()}),c.on("click",".fpd-remove-row",function(){var a=$(this).parents(".fpd-row:first");a.siblings(".fpd-row").length>0&&(a.remove(),f())}),c.on("change","select",function(){var a=$(this);a.removeClass("fpd-error")}),c.on("change",".fpd-quantity",function(){var a=$(this);this.value<Number(a.attr("min"))&&(this.value=Number(a.attr("min"))),""==this.value&&(this.value=1),f()}),f()};g()};